digraph Automaton {
    rankdir=TB
    splines=true;
    overlap=false;
    nodesep=0.4;
    ranksep=0.9;

    node [shape=circle];

    { rank=same; q0  [label="ε"]; }

    { rank=same; q1  [label="a"];
                q12 [label="b"]; }

    { rank=same; q2  [label="aa"];
                q8  [label="ab"];
                q13 [label="ba"];
                q18 [label="bb"]; }

    { rank=same; q3  [label="aaa", shape=doublecircle];
                q4  [label="aab"];
                q9  [label="aba"];
                q10 [label="abb"];
                q14 [label="baa"];
                q16 [label="bab"];
                q19 [label="bbb"]; }

    { rank=same; q5  [label="aaba"];
                q6  [label="aabb"];
                q11 [label="abbb"];
                q15 [label="baab"];
                q17 [label="babb"]; }

    { rank=same; q7  [label="aabbb"]; }


    q0 -> q1  [label="a"];
    q0 -> q12 [label="b"];

    q1  -> q2  [label="a"];
    q1  -> q8  [label="b"];

    q2  -> q3  [label="a"];
    q2  -> q4  [label="b"];

    q3  -> q3  [label="a, b", constraint=false];

    q4  -> q5  [label="a"];
    q4  -> q6  [label="b"];

    q5  -> q3  [label="a, b", constraint=false];

    q6  -> q3  [label="a", constraint=false];
    q6  -> q7  [label="b"];

    q7  -> q3  [label="a", constraint=false];
    q7  -> q5  [label="b", constraint=false];

    q8  -> q9  [label="a"];
    q8  -> q10 [label="b"];

    q9  -> q3  [label="a, b", constraint=false];

    q10 -> q3  [label="a", constraint=false];
    q10 -> q11 [label="b"];

    q11 -> q3  [label="a", constraint=false];
    q11 -> q9  [label="b", constraint=false];

    // ветка от 'b'
    q12 -> q13 [label="a"];
    q12 -> q18 [label="b"];

    q13 -> q14 [label="a"];
    q13 -> q16 [label="b"];

    q14 -> q3  [label="a", constraint=false];
    q14 -> q15 [label="b"];

    q15 -> q3  [label="a, b", constraint=false];

    q16 -> q15 [label="a"];
    q16 -> q17 [label="b"];

    q17 -> q3  [label="a", constraint=false];
    q17 -> q14 [label="b", constraint=false];

    q18 -> q16 [label="a"];
    q18 -> q19 [label="b"];

    q19 -> q17 [label="a"];
    q19 -> q13 [label="b", constraint=false];
}
